<!-- templates/analytics/dashboard.html -->
{% extends "partials/base.html" %}

{% block title %}Dashboard Analitik Lab{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ðŸ“Š Dashboard Analitik Lab</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">Kembali ke Jadwal</a>
</div>

<!-- Toggle antara Grafik & Tabel -->
<ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="grafik-tab" data-bs-toggle="tab" data-bs-target="#grafik" type="button"
            role="tab">Grafik</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tabel-tab" data-bs-toggle="tab" data-bs-target="#tabel" type="button"
            role="tab">Tabel Data</button>
    </li>
</ul>

<!-- Bagian Grafik (Default Terlihat) -->
<div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="grafik" role="tabpanel">
        <div id="grafikSection">
            <!-- Ringkasan Kartu -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">Total Bahan</h5>
                            <p class="card-text display-6">{{ total_bahan }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">Total Alat</h5>
                            <p class="card-text display-6">{{ total_alat }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-purple">
                        <div class="card-body">
                            <h5 class="card-title">Bahan Expired</h5>
                            <p class="card-text display-6">{{ expired_bahan }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body">
                            <h5 class="card-title">Alat Rusak</h5>
                            <p class="card-text display-6">{{ rusak_alat }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Grafik Utama: 3 Kolom -->
            <div class="row g-4 mb-4">
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>Bahan per Lab</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="bahanChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>Alat per Lab</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="alatChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5>Jadwal Penggunaan</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="jadwalChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kejadian per Bulan -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Kejadian per Bulan</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="kejadianBulanChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Kejadian per Lab -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Kejadian per Lab</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="kejadianLabChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- === GRAFIK TAMBAHAN SESUAI PERMINTAAN === -->

            <!-- Histogram: Kelas vs Jumlah Eksperimen -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Histogram: Kelas vs Jumlah Eksperimen</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="histogramKelasChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Histogram: Nama Guru vs Jumlah Eksperimen -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Histogram: Nama Guru vs Jumlah Eksperimen</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="histogramGuruChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Histogram: Nama Lab vs Expired Bahan -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Histogram: Nama Lab vs Bahan Expired</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="histogramLabExpiredChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Histogram: Nama Lab vs Status Alat (Stacked Bar) -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Histogram: Nama Lab vs Status Alat</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="histogramLabAlatChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Piechart: Bahan per Lab -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Piechart: Bahan per Lab</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="piechartBahanChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Piechart: Alat per Lab -->
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>Piechart: Alat per Lab</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="piechartAlatChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bagian Tabel Data (Sembunyikan Awalnya) -->
    <div class="tab-pane fade" id="tabel" role="tabpanel">
        <!-- BAHAN -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Bahan (Total: {{ bahan_list|length }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="bahanTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kode</th>
                                <th>Nama Bahan</th>
                                <th>Kuantitas</th>
                                <th>Total Digunakan</th>
                                <th>Sisa Tersedia</th>
                                <th>Tgl Masuk</th>
                                <th>Tgl Expired</th>
                                <th>Status Expired</th>
                                <th>Countdown</th>
                                <th>Lab</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for b in bahan_list %}
                            <tr>
                                <td>{{ b.id }}</td>
                                <td>{{ b.kode }}</td>
                                <td>{{ b.nama_bahan }}</td>
                                <td>{{ "%.2f"|format(b.kuantitas) }}</td>
                                <td>{{ "%.2f"|format(b.total_digunakan) }}</td>
                                <td>{{ "%.2f"|format(b.sisa_tersedia) }}</td>
                                <td>{{ b.tgl_masuk }}</td>
                                <td>{{ b.tgl_expired or '-' }}</td>
                                <td>
                                    <span class="badge bg-{% if b.status_expired == 'expired' %}danger{% else %}success{% endif %}">
                                        {{ b.status_expired }}
                                    </span>
                                </td>
                                <td>
                                    {% if b.countdown_seconds and b.countdown_seconds > 0 %}
                                    <span class="badge bg-info" data-countdown="{{ b.countdown_seconds }}">{{ b.countdown_str }}</span>
                                    {% elif b.status_expired == 'expired' %}
                                    <span class="badge bg-danger">Expired</span>
                                    {% else %}
                                    <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ b.nama_lab }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="11" class="text-center">Tidak ada data bahan.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // Fungsi untuk memperbarui countdown secara real-time
            function updateCountdowns() {
                const countdownElements = document.querySelectorAll('[data-countdown]');
                countdownElements.forEach(element => {
                    const totalSeconds = parseInt(element.getAttribute('data-countdown'));
                    if (totalSeconds > 0) {
                        const days = Math.floor(totalSeconds / (24 * 3600));
                        const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
                        const minutes = Math.floor((totalSeconds % 3600) / 60);
                        const seconds = totalSeconds % 60;

                        const display = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                        element.textContent = display;
                        element.setAttribute('data-countdown', totalSeconds - 1);
                    } else {
                        element.textContent = 'Expired';
                        element.classList.remove('bg-info');
                        element.classList.add('bg-danger');
                    }
                });
            }
            setInterval(updateCountdowns, 1000);
            document.addEventListener('DOMContentLoaded', function () {
                updateCountdowns();
            });
        </script>

        <!-- ALAT -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Alat (Total: {{ alat_list|length }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="alatTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kode</th>
                                <th>Nama Alat</th>
                                <th>Kuantitas</th>
                                <th>Total Digunakan</th>
                                <th>Sedang Dipakai</th>
                                <th>Rusak</th>
                                <th>Tersedia Baik</th>
                                <th>Tgl Masuk</th>
                                <th>Status</th>
                                <th>Lab</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in alat_list %}
                            <tr>
                                <td>{{ a.id }}</td>
                                <td>{{ a.kode }}</td>
                                <td>{{ a.nama_alat }}</td>
                                <td>{{ a.kuantitas }}</td>
                                <td>{{ a.total_digunakan }}</td>
                                <td>{{ a.sedang_dipakai }}</td>
                                <td>{{ a.rusak }}</td>
                                <td>{{ a.tersedia_baik }}</td>
                                <td>{{ a.tgl_masuk }}</td>
                                <td>
                                    <span class="badge bg-{% if a.status == 'rusak' %}danger{% else %}success{% endif %}">
                                        {{ a.status }}
                                    </span>
                                </td>
                                <td>{{ a.nama_lab }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="11" class="text-center">Tidak ada data alat.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- KEJADIAN -->
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Kejadian (Total: {{ kejadian_list|length }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="kejadianTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Guru</th>
                                <th>Kelas</th>
                                <th>Sesi</th>
                                <th>Alat ID</th>
                                <th>Rusak</th>
                                <th>Status</th>
                                <th>Lab</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for k in kejadian_list %}
                            <tr>
                                <td>{{ k.id }}</td>
                                <td>{{ k.tanggal_kejadian }}</td>
                                <td>{{ k.nama_guru }}</td>
                                <td>{{ k.kelas }}</td>
                                <td>{{ k.sesi }}</td>
                                <td>{{ k.alat_id }}</td>
                                <td>{{ k.kuantitas_rusak }}</td>
                                <td>
                                    {% if k.status == 'sudah diperbaiki' %}
                                    <span class="badge bg-success">sudah diperbaiki</span>
                                    {% else %}
                                    <span class="badge bg-purple">belum ditangani</span>
                                    {% endif %}
                                </td>
                                <td>{{ k.nama_lab }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="9" class="text-center">Tidak ada data kejadian.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- JADWAL -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Jadwal Penggunaan (Total: {{ jadwal_list|length }})</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="jadwalTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Guru</th>
                                <th>Sesi</th>
                                <th>Kelas</th>
                                <th>Praktikum</th>
                                <th>Kelompok</th>
                                <th>Lab</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for j in jadwal_list %}
                            <tr>
                                <td>{{ j.id }}</td>
                                <td>{{ j.tanggal }}</td>
                                <td>{{ j.nama_guru }}</td>
                                <td>{{ j.sesi }}</td>
                                <td>{{ j.kelas }}</td>
                                <td>{{ j.judul_praktikum }}</td>
                                <td>{{ j.jumlah_kelompok }}</td>
                                <td>{{ j.nama_lab }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="8" class="text-center">Tidak ada data jadwal.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Custom JS untuk Chart dan DataTable -->
<script>
    $(document).ready(function () {
        // --- Inisialisasi DataTables ---
        function initDataTable(tableId) {
            $(tableId).DataTable({
                "pageLength": 10,
                "scrollY": "300px",
                "scrollX": true,
                "scrollCollapse": true,
                "ordering": true,
                "searching": true,
                "language": {
                    "search": "Cari:",
                    "paginate": {
                        "previous": "Sebelumnya",
                        "next": "Berikutnya"
                    },
                    "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                    "emptyTable": "Tidak ada data tersedia"
                }
            });
        }
        initDataTable('#bahanTable');
        initDataTable('#alatTable');
        initDataTable('#kejadianTable');
        initDataTable('#jadwalTable');

        // --- Inisialisasi Chart.js ---
        fetch('/api/analytics/data')
            .then(response => {
                if (!response.ok) {
                     throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error('API Error:', data.error);
                    flash('Gagal memuat data grafik: ' + data.error, 'danger'); // Jika Anda memiliki sistem flash di JS
                    return;
                }

                // === CHART YANG SUDAH ADA ===
                new Chart(document.getElementById('bahanChart'), {
                    type: 'bar',
                    data: {
                        labels: data.bahan.per_lab.map(item => item.lab),
                        datasets: [{
                            label: 'Jumlah Bahan',
                            data: data.bahan.per_lab.map(item => item.count),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                new Chart(document.getElementById('alatChart'), {
                    type: 'bar',
                    data: {
                        labels: data.alat.per_lab.map(item => item.lab),
                        datasets: [{
                            label: 'Jumlah Alat',
                            data: data.alat.per_lab.map(item => item.count),
                            backgroundColor: 'rgba(75, 192, 192, 0.6)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                new Chart(document.getElementById('jadwalChart'), {
                    type: 'bar',
                    data: {
                        labels: data.jadwal.per_lab.map(item => item.lab),
                        datasets: [{
                            label: 'Jumlah Jadwal',
                            data: data.jadwal.per_lab.map(item => item.count),
                            backgroundColor: 'rgba(153, 102, 255, 0.6)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                new Chart(document.getElementById('kejadianBulanChart'), {
                    type: 'line',
                    data: {
                        labels: data.kejadian.per_bulan.map(item => item.bulan),
                        datasets: [{
                            label: 'Jumlah Kejadian',
                            data: data.kejadian.per_bulan.map(item => item.count),
                            borderColor: 'rgba(255, 99, 132, 1)',
                            fill: false
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                new Chart(document.getElementById('kejadianLabChart'), {
                    type: 'bar',
                    data: {
                        labels: data.kejadian.per_lab.map(item => item.lab),
                        datasets: [{
                            label: 'Jumlah Kejadian',
                            data: data.kejadian.per_lab.map(item => item.count),
                            backgroundColor: 'rgba(255, 159, 64, 0.6)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // === CHART TAMBAHAN SESUAI PERMINTAAN ===

                // Histogram: Kelas vs Jumlah Eksperimen
                new Chart(document.getElementById('histogramKelasChart'), {
                    type: 'bar',
                    data: {
                        labels: data.histogram.kelas.labels,
                        datasets: [{
                            label: 'Jumlah Eksperimen',
                            data: data.histogram.kelas.data,
                            backgroundColor: 'rgba(255, 205, 86, 0.6)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Histogram: Nama Guru vs Jumlah Eksperimen
                new Chart(document.getElementById('histogramGuruChart'), {
                    type: 'bar',
                    data: {
                        labels: data.histogram.guru.labels,
                        datasets: [{
                            label: 'Jumlah Eksperimen',
                            data: data.histogram.guru.data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Histogram: Nama Lab vs Expired Bahan
                new Chart(document.getElementById('histogramLabExpiredChart'), {
                    type: 'bar',
                    data: {
                        labels: data.histogram.lab_expired.labels,
                        datasets: [{
                            label: 'Jumlah Bahan Expired',
                            data: data.histogram.lab_expired.data,
                            backgroundColor: 'rgba(255, 99, 132, 0.6)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Histogram: Nama Lab vs Status Alat (Stacked Bar)
                new Chart(document.getElementById('histogramLabAlatChart'), {
                    type: 'bar',
                    data: {
                        labels: data.histogram.lab_alat.labels,
                        datasets: [
                            {
                                label: 'Tersedia Baik',
                                data: data.histogram.lab_alat.baik,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)'
                            },
                            {
                                label: 'Rusak',
                                data: data.histogram.lab_alat.rusak,
                                backgroundColor: 'rgba(255, 99, 132, 0.6)'
                            },
                            {
                                label: 'Sedang Dipakai',
                                data: data.histogram.lab_alat.digunakan,
                                backgroundColor: 'rgba(153, 102, 255, 0.6)'
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true }
                        }
                    }
                });

                // Piechart: Bahan per Lab
                new Chart(document.getElementById('piechartBahanChart'), {
                    type: 'pie',
                    data: {
                        labels: data.piechart.bahan.map(item => item.lab),
                        datasets: [{
                            label: 'Jumlah Bahan',
                            data: data.piechart.bahan.map(item => item.count),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 205, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)'
                            ]
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Piechart: Alat per Lab
                new Chart(document.getElementById('piechartAlatChart'), {
                    type: 'pie',
                    data: {
                        labels: data.piechart.alat.map(item => item.lab),
                        datasets: [{
                            label: 'Jumlah Alat',
                            data: data.piechart.alat.map(item => item.count),
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(199, 199, 199, 0.6)'
                            ]
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
                alert('Gagal memuat data grafik. Silakan muat ulang halaman.');
            });
    });
</script>

<!-- CSS untuk warna ungu -->
<style>
    .bg-purple {
        background-color: #9c27b0 !important;
    }
</style>
{% endblock %}