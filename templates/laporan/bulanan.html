<!-- templates/laporan/bulanan.html -->
{% extends "partials/base.html" %}

{% block title %}Laporan Bulanan Lab{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ðŸ“Š Laporan Bulanan Laboratorium</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">Kembali ke Jadwal</a>
</div>

<!-- Filter Bulan & Tahun -->
<form method="GET" class="mb-4">
    <div class="row">
        <div class="col-md-3">
            <label for="bulan" class="form-label">Bulan</label>
            <select name="bulan" id="bulan" class="form-select">
                {% for i in range(1, 13) %}
                <option value="{{ i }}" {% if i == bulan_sekarang %}selected{% endif %}>{{ nama_bulan_list[i-1] }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="tahun" class="form-label">Tahun</label>
            <input type="number" name="tahun" id="tahun" class="form-control" 
                   min="2020" max="{{ tahun_sekarang + 1 }}" value="{{ tahun_sekarang }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary">Tampilkan</button>
            <a href="{{ url_for('laporan_bulanan') }}" class="btn btn-secondary ms-2">Reset</a>
        </div>
<div class="col-12 col-md-6 d-flex justify-content-md-end flex-wrap gap-2 ms-md-auto">
    <!-- Tombol Download -->
    <div class="dropdown">
        <button class="btn btn-danger dropdown-toggle" type="button" id="dropdownPdf" data-bs-toggle="dropdown">
            <i class="bi bi-file-earmark-pdf"></i> PDF
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('download_laporan_pdf', bulan=bulan, tahun=tahun, orientasi='portrait') }}" target="_blank">Portrait</a></li>
            <li><a class="dropdown-item" href="{{ url_for('download_laporan_pdf', bulan=bulan, tahun=tahun, orientasi='landscape') }}" target="_blank">Landscape</a></li>
        </ul>
    </div>
    <a href="{{ url_for('download_laporan_xlsx', bulan=bulan, tahun=tahun) }}" class="btn btn-success">
        <i class="bi bi-file-earmark-excel"></i> Excel
    </a>
</div>
    </div>
</form>

<!-- Ringkasan Kartu -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">Total Bahan</h5>
                <p class="card-text display-6">{{ total_bahan }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Total Alat</h5>
                <p class="card-text display-6">{{ total_alat }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-purple">
            <div class="card-body">
                <h5 class="card-title">Bahan Expired</h5>
                <p class="card-text display-6">{{ expired_bahan }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <h5 class="card-title">Alat Rusak</h5>
                <p class="card-text display-6">{{ rusak_alat }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Tabel-Tabel Laporan dalam Accordion -->
<div class="accordion" id="laporanAccordion">

    <!-- Bahan Detail -->
    <div class="accordion-item mb-3">
        <h2 class="accordion-header" id="headingBahanDetail">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBahanDetail">
                Detail Bahan (Stok & Penggunaan)
            </button>
        </h2>
        <div id="collapseBahanDetail" class="accordion-collapse collapse show">
            <div class="accordion-body">
                <div class="table-responsive">
                    <table id="bahanTable" class="table table-striped table-hover" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Kode</th>
                                <th>Nama Bahan</th>
                                <th>Satuan</th>
                                <th>Kuantitas</th>
                                <th>Total Digunakan</th>
                                <th>Sisa Tersedia</th>
                                <th>Tgl Masuk</th>
                                <th>Tgl Expired</th>
                                <th>Status Expired</th>
                                <th>Countdown</th>
                                <th>Lab</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for b in bahan_list %}
                            <tr>
                                <td>{{ b.id }}</td>
                                <td>{{ b.kode }}</td>
                                <td>{{ b.nama_bahan }}</td>
                                <td>{{ b.satuan }}</td>
                                <td>{{ "%.2f"|format(b.kuantitas) }}</td>
                                <td>{{ "%.2f"|format(b.total_digunakan) }}</td>
                                <td>{{ "%.2f"|format(b.sisa_tersedia) }}</td>
                                <td>{{ b.tgl_masuk.strftime('%d %b %Y') }}</td>
                                <td>{{ b.tgl_expired.strftime('%d %b %Y') if b.tgl_expired else '-' }}</td>
                                <td>
                                    <span class="badge bg-{% if b.status_expired == 'expired' %}danger{% else %}success{% endif %}">
                                        {{ b.status_expired }}
                                    </span>
                                </td>
                                <td>
                                    {% if b.countdown_seconds and b.countdown_seconds > 0 %}
                                    <span class="badge bg-info" data-countdown="{{ b.countdown_seconds }}">{{ b.countdown_str }}</span>
                                    {% elif b.status_expired == 'expired' %}
                                    <span class="badge bg-danger">Expired</span>
                                    {% else %}
                                    <span class="badge bg-secondary">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ b.nama_lab }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="12" class="text-center">Tidak ada data bahan.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Alat Detail -->
    <div class="accordion-item mb-3">
        <h2 class="accordion-header" id="headingAlatDetail">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAlatDetail">
                Detail Alat (Status & Catatan)
            </button>
        </h2>
        <div id="collapseAlatDetail" class="accordion-collapse collapse">
            <div class="accordion-body">
                <div class="table-responsive">
                    <table id="alatTable" class="table table-striped table-hover" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Kode</th>
                                <th>Nama Alat</th>
                                <th>Satuan</th>
                                <th>Kuantitas</th>
                                <th>Total Digunakan</th>
                                <th>Sedang Dipakai</th>
                                <th>Rusak</th>
                                <th>Tersedia Baik</th>
                                <th>Tgl Masuk</th>
                                <th>Status</th>
                                <th>Catatan</th>
                                <th>Lab</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in alat_list %}
                            <tr>
                                <td>{{ a.id }}</td>
                                <td>{{ a.kode }}</td>
                                <td>{{ a.nama_alat }}</td>
                                <td>{{ a.satuan }}</td>
                                <td>{{ a.kuantitas }}</td>
                                <td>{{ a.total_digunakan }}</td>
                                <td>{{ a.sedang_dipakai }}</td>
                                <td>{{ a.rusak }}</td>
                                <td>{{ a.tersedia_baik }}</td>
                                <td>{{ a.tgl_masuk.strftime('%d %b %Y') }}</td>
                                <td>
                                    <span class="badge bg-{% if a.status == 'rusak' %}danger{% else %}success{% endif %}">
                                        {{ a.status }}
                                    </span>
                                </td>
                                <td>{{ a.catatan or '-' }}</td>
                                <td>{{ a.nama_lab }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="13" class="text-center">Tidak ada data alat.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Kejadian Detail -->
    <div class="accordion-item mb-3">
        <h2 class="accordion-header" id="headingKejadianDetail">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseKejadianDetail">
                Detail Kejadian
            </button>
        </h2>
        <div id="collapseKejadianDetail" class="accordion-collapse collapse">
            <div class="accordion-body">
                <div class="table-responsive">
                    <table id="kejadianTable" class="table table-striped table-hover" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Guru</th>
                                <th>Kelas</th>
                                <th>Sesi</th>
                                <th>Alat</th>
                                <th>Rusak</th>
                                <th>Deskripsi</th>
                                <th>Status</th>
                                <th>Lab</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for k in kejadian_list %}
                            <tr>
                                <td>{{ k.id }}</td>
                                <td>{{ k.tanggal_kejadian.strftime('%d %b %Y') }}</td>
                                <td>{{ k.nama_guru }}</td>
                                <td>{{ k.kelas }}</td>
                                <td>{{ k.sesi }}</td>
                                <td>{{ k.alat.nama_alat if k.alat else 'Tidak Diketahui' }}</td>
                                <td>{{ k.kuantitas_rusak }}</td>
                                <td class="text-truncate" style="max-width: 150px;">{{ k.deskripsi or '-' }}</td>
                                <td>
                                    <span class="badge bg-{% if k.status == 'sudah diperbaiki' %}success{% else %}warning{% endif %}">
                                        {{ k.status }}
                                    </span>
                                </td>
                                <td>{{ k.nama_lab }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="10" class="text-center">Tidak ada data kejadian.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Berita Acara Detail -->
    <div class="accordion-item mb-3">
        <h2 class="accordion-header" id="headingBeritaAcaraDetail">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBeritaAcaraDetail">
                Detail Berita Acara
            </button>
        </h2>
        <div id="collapseBeritaAcaraDetail" class="accordion-collapse collapse">
            <div class="accordion-body">
                <div class="table-responsive">
                    <table id="beritaAcaraTable" class="table table-striped table-hover" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Jenis</th>
                                <th>Nama Item</th>
                                <th>Alasan</th>
                                <th>Keterangan</th>
                                <th>Petugas</th>
                                <th>Status Follow Up</th>
                                <th>Kuantitas Tindakan</th>
                                <th>Tgl Tindakan</th>
                                <th>Catatan Tindakan</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ba in berita_acara_list %}
                            <tr>
                                <td>{{ ba.id }}</td>
                                <td>{{ ba.tanggal.strftime('%d %b %Y') }}</td>
                                <td>{{ ba.jenis.title() }}</td>
                                <td>{{ ba.nama_item }}</td>
                                <td>{{ ba.alasan }}</td>
                                <td class="text-truncate" style="max-width: 150px;">{{ ba.keterangan or '-' }}</td>
                                <td>{{ ba.nama_petugas }}</td>
                                <td>
                                    <span class="badge bg-{% if ba.status_follow_up == 'Sudah Ditangani' %}success{% else %}warning{% endif %}">
                                        {{ ba.status_follow_up or 'Belum Ditangani' }}
                                    </span>
                                </td>
                                <td>{{ ba.kuantitas_tindakan or 0 }}</td>
                                <td>{{ ba.tanggal_tindakan.strftime('%d %b %Y') if ba.tanggal_tindakan else '-' }}</td>
                                <td class="text-truncate" style="max-width: 150px;">{{ ba.catatan_tindakan or '-' }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="11" class="text-center">Tidak ada data berita acara.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<!-- DataTables -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function () {
    // === INISIALISASI DATATABLES ===
    function initDataTable(tableId) {
        $(tableId).DataTable({
            "pageLength": 10,
            "scrollY": "300px",
            "scrollX": true,
            "scrollCollapse": true,
            "ordering": true,
            "searching": true,
            "language": {
                "search": "Cari:",
                "paginate": {
                    "previous": "Sebelumnya",
                    "next": "Berikutnya"
                },
                "info": "Menampilkan _START_ sampai _END_ dari _TOTAL_ entri",
                "emptyTable": "Tidak ada data tersedia"
            }
        });
    }

    // Inisialisasi semua tabel
    initDataTable('#bahanTable');
    initDataTable('#alatTable');
    initDataTable('#kejadianTable');
    initDataTable('#beritaAcaraTable');

    // === UPDATE COUNTDOWN REALTIME ===
    function updateCountdowns() {
        const countdownElements = document.querySelectorAll('[data-countdown]');
        countdownElements.forEach(element => {
            const totalSeconds = parseInt(element.getAttribute('data-countdown'));
            if (totalSeconds > 0) {
                const days = Math.floor(totalSeconds / (24 * 3600));
                const hours = Math.floor((totalSeconds % (24 * 3600)) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                const display = `${days}d ${hours}h ${minutes}m ${seconds}s`;
                element.textContent = display;
                element.setAttribute('data-countdown', totalSeconds - 1);
            } else {
                element.textContent = 'Expired';
                element.classList.remove('bg-info');
                element.classList.add('bg-danger');
            }
        });
    }

    setInterval(updateCountdowns, 1000);
    document.addEventListener('DOMContentLoaded', function () {
        updateCountdowns();
    });
});
</script>

<!-- CSS untuk warna ungu -->
<style>
.bg-purple { background-color: #9c27b0 !important; }
</style>
{% endblock %}